<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Itai's Easy Ear Trainer</title>
  <style>
    :root{
      --bg:#eae2d6; --bg2:#e5dbc9; --panel:#fffaf3; --panel-border:#e3d8c7; --ink:#2a2927; --muted:#6f685f;
      --accent:#b08a59; --accent-2:#d6b48a; --success:#2a7f62; --danger:#9e3b38; --shadow:0 8px 20px rgba(42,41,39,.08);
    }
    html,body{height:100%}
    body{margin:0; font-family: ui-serif, Georgia, "Times New Roman", serif; color:var(--ink);
      background: radial-gradient(1200px 800px at 20% -10%, var(--bg2), transparent 60%),
                  radial-gradient(1000px 700px at 120% 10%, var(--bg2), transparent 55%),
                  linear-gradient(180deg, var(--bg), #f9f4ec);
    }
    .wrap{max-width:1120px; margin:0 auto; padding:24px}
    h1{margin:0 0 8px; font-size:22px}
    .muted{color:var(--muted); font-size:13px}
    .row{display:flex; gap:20px; flex-wrap:wrap}
    .col{flex:1 1 320px}
    .panel{background:var(--panel); border:1px solid var(--panel-border); border-radius:18px; box-shadow:var(--shadow); padding:20px}
    .panel h3{margin:0 0 10px; font-size:18px}
    .btn{display:inline-block; padding:9px 14px; border-radius:12px; font-weight:600; border:1px solid #1b1a19; background:linear-gradient(180deg,#1f1e1c,#2a2927); color:#fff; cursor:pointer}
    .btn.ghost{border-color:var(--panel-border); background:linear-gradient(#fffaf3,#f7efdf); color:var(--ink)}
    .btn:disabled{opacity:.6; cursor:not-allowed}
    .grid{display:grid; grid-template-columns: repeat(5, minmax(0,1fr)); gap:8px}
    .choice{border:1px solid var(--panel-border); background:linear-gradient(#fffaf3,#f6edde); border-radius:12px; padding:8px 10px; font-size:13px; cursor:pointer}
    .choice.active{background:linear-gradient(#2a2927,#1f1e1c); color:#fff; border-color:#1f1e1c}
    .rowline{display:flex; align-items:center; gap:8px}
    .fader{appearance:none; width:100%; height:6px; border-radius:999px; background:linear-gradient(90deg,var(--accent-2),var(--accent)); outline:none}
    .fader::-webkit-slider-thumb{appearance:none; width:18px; height:18px; border-radius:50%; background:#fff; border:1px solid #cdbda4}
    .fader::-moz-range-thumb{width:18px; height:18px; border-radius:50%; background:#fff; border:1px solid #cdbda4}
    .pass{color:var(--success)} .fail{color:var(--danger)}
    .log{max-height:180px; overflow:auto; border:1px solid var(--panel-border); border-radius:12px; background:var(--panel)}
    .logrow{display:flex; gap:10px; font-size:12px; padding:6px 10px; align-items:center}
    .w16{width:64px} .w40{width:160px; overflow:hidden; text-overflow:ellipsis; white-space:nowrap}

    .abseg-wrap{display:flex; border:1px solid #1b1a19; border-radius:999px; overflow:hidden; box-shadow:var(--shadow)}
    .abseg{padding:8px 14px; font-weight:700; font-size:13px; cursor:pointer; user-select:none; border:none}
    .abseg.left{border-right:1px solid #1b1a19}
    .abseg:not(.active){background:linear-gradient(#fffaf3,#f2e7d7); color:var(--ink)}
    .abseg.active{background:linear-gradient(180deg,#1f1e1c,#2a2927); color:#fff}

    .unlock{position:fixed; inset:0; display:flex; align-items:center; justify-content:center; background:rgba(42,41,39,.55); backdrop-filter: blur(2px) saturate(120%); z-index:9999}
    .unlock[hidden]{display:none}
    .unlock .card{background:var(--panel); border:1px solid var(--panel-border); border-radius:18px; padding:20px; text-align:center; max-width:380px; box-shadow:var(--shadow)}
  </style>
</head>
<body>
  <div class="wrap">
    <header class="row" style="justify-content:space-between; align-items:center; margin-bottom:16px">
      <div>
        <h1>Itai's Easy Ear Trainer</h1>
        <div class="muted">A = your EQ (choose band + gain type). B = target EQ (hidden). Toggle A/B to compare.</div>
      </div>
      <div class="rowline">
        <button id="playBtn" class="btn">Play</button>
        <div class="abseg-wrap" role="group" aria-label="A/B toggle">
          <button id="abA" class="abseg left" title="Hear your A path (user EQ)">A</button>
          <button id="abB" class="abseg" title="Hear B path (hidden target)">B</button>
        </div>
      </div>
    </header>

    <div class="row">
      <div class="col">
        <div class="panel">
          <h3>Source & Transport</h3>
          <div class="rowline" style="margin-bottom:8px">
            <span class="muted">Pink Noise</span>
          </div>
          <div class="rowline">
            <span class="muted" style="width:56px">Volume</span>
            <input id="vol" class="fader" type="range" min="0" max="1" step="0.01" value="0.9" />
            <span id="volPct" class="muted" style="width:40px; text-align:right">90%</span>
          </div>
          <div class="muted" style="margin-top:6px">If audio is silent, press Play to initialize the audio context (browser safety).</div>
        </div>

        <div class="panel" style="margin-top:16px">
          <div class="row" style="justify-content:space-between; align-items:center">
            <h3 style="margin:0">Stats & Export</h3>
            <button id="exportBtn" class="btn ghost">Export CSV</button>
          </div>
          <div class="row" style="gap:24px; margin-top:8px">
            <div class="muted" style="text-align:center"><div id="scCorrect" style="font-size:24px; font-weight:700; color:var(--ink)">0</div>Correct</div>
            <div class="muted" style="text-align:center"><div id="scTotal" style="font-size:24px; font-weight:700; color:var(--ink)">0</div>Attempts</div>
            <div class="muted" style="text-align:center"><div id="scAcc" style="font-size:24px; font-weight:700; color:var(--ink)">0%</div>Accuracy</div>
          </div>
          <div class="muted" style="margin:10px 0 4px">Recent results</div>
          <div class="log" id="log"></div>
        </div>
      </div>

      <div class="col" style="flex:2 1 520px">
        <div class="panel">
          <div class="row" style="justify-content:space-between; align-items:center">
            <h3 style="margin:0">Match B with A (Pink Noise)</h3>
            <button id="newRound" class="btn">New Round</button>
          </div>
          <div class="muted" style="margin-bottom:8px">B path has a hidden bell EQ (±6 dB, Q 5, or none). Choose the A frequency and gain type to match it. Target stays hidden until you check.</div>

          <div class="grid" id="freqGrid" style="margin-bottom:10px"></div>

          <div class="grid" style="grid-template-columns:repeat(3,minmax(0,1fr)); margin-bottom:10px">
            <button class="choice" data-gain="boost">Boost</button>
            <button class="choice" data-gain="cut">Cut</button>
            <button class="choice active" data-gain="none">No Boost/Cut</button>
          </div>

          <div class="rowline" style="margin-top:8px; gap:12px">
            <button id="checkBtn" class="btn">Check</button>
            <div class="muted" id="hint">Target: (hidden) | Your A: — Hz, none</div>
          </div>
          <div id="inlineResult" style="margin-top:8px; font-size:14px"></div>
        </div>
      </div>
    </div>

    <footer class="muted" style="text-align:center; margin-top:24px">© <span id="year"></span> Ear Trainer – built for mix engineers.</footer>
  </div>

  <div id="unlock" class="unlock" hidden>
    <div class="card">
      <h3 style="margin:0 0 6px">Enable Audio</h3>
      <p class="muted" style="margin:0 0 12px">Browsers block sound until you interact. Tap below to start the audio engine.</p>
      <button id="unlockBtn" class="btn">Tap to Start</button>
    </div>
  </div>

  <script>
    const niceFreqs = [125, 250, 500, 750, 1000, 1500, 2000, 3000, 4000, 6000, 8000, 12000];
    const MOD_GAIN_DB = 6;
    const MOD_Q = 5;
    const NL = "\n";
    const fmtBand = (f) => (f >= 1000 ? (f/1000)+"k" : String(f));

    function weightedPick(values, weights){
      const s = weights.reduce((a,b)=>a+b,0);
      let r = Math.random()*s;
      for(let i=0;i<values.length;i++){ r -= weights[i]; if(r <= 0) return values[i]; }
      return values[values.length-1];
    }

    class AudioEngine {
      constructor(){
        const AC = window.AudioContext || window.webkitAudioContext;
        this.ctx = new AC();
        this.master = this.ctx.createGain(); this.master.gain.value = 0.9; this.master.channelCountMode = 'explicit'; this.master.channelCount = 2;
        this.dryEq = this.ctx.createBiquadFilter(); this.dryEq.type='peaking'; this.dryEq.Q.value = MOD_Q; this.dryEq.frequency.value=1000; this.dryEq.gain.value=0; this.dryEq.channelCountMode='explicit'; this.dryEq.channelCount=2;
        this.dryGain = this.ctx.createGain(); this.dryGain.gain.value = 1; this.dryGain.channelCountMode='explicit'; this.dryGain.channelCount=2;
        this.eq = this.ctx.createBiquadFilter(); this.eq.type='peaking'; this.eq.Q.value = MOD_Q; this.eq.frequency.value=1000; this.eq.gain.value=0; this.eq.channelCountMode='explicit'; this.eq.channelCount=2;
        this.wetGain = this.ctx.createGain(); this.wetGain.gain.value = 0; this.wetGain.channelCountMode='explicit'; this.wetGain.channelCount=2;
        this.dryEq.connect(this.dryGain); this.dryGain.connect(this.master); this.eq.connect(this.wetGain); this.wetGain.connect(this.master); this.master.connect(this.ctx.destination);
        this.sourceNode = null; this.isPlaying=false; this.bufferForPinkNoise = this.createPinkNoiseBuffer(6);
      }
      async resume(){ if(this.ctx.state!=='running') await this.ctx.resume(); }
      toggleAB(on){ const now=this.ctx.currentTime, t=0.03; this.dryGain.gain.cancelScheduledValues(now); this.wetGain.gain.cancelScheduledValues(now); if(on){ this.dryGain.gain.linearRampToValueAtTime(0, now+t); this.wetGain.gain.linearRampToValueAtTime(1, now+t);} else { this.dryGain.gain.linearRampToValueAtTime(1, now+t); this.wetGain.gain.linearRampToValueAtTime(0, now+t);} }
      setMasterGain(v){ this.master.gain.value = v; }
      bypassAll(){ this.eq.gain.value=0; this.eq.Q.value=MOD_Q; this.eq.frequency.value=1000; this.dryEq.gain.value=0; this.dryEq.Q.value=MOD_Q; this.dryEq.frequency.value=1000; }
      setTargetEQ({freq=1000,gainDb=0}){ this.eq.frequency.setValueAtTime(freq,this.ctx.currentTime); this.eq.Q.setValueAtTime(MOD_Q,this.ctx.currentTime); this.eq.gain.setValueAtTime(gainDb,this.ctx.currentTime); }
      setUserEQ({freq=1000,gainDb=0}){ this.dryEq.frequency.setValueAtTime(freq,this.ctx.currentTime); this.dryEq.Q.setValueAtTime(MOD_Q,this.ctx.currentTime); this.dryEq.gain.setValueAtTime(gainDb,this.ctx.currentTime); }
      stop(){ if(this.sourceNode){ try{this.sourceNode.stop()}catch{} try{this.sourceNode.disconnect()}catch{} this.sourceNode=null; } this.isPlaying=false; }
      start(){ this.stop(); const src=this.ctx.createBufferSource(); src.channelCountMode='explicit'; src.channelCount=2; src.buffer = this.bufferForPinkNoise; src.loop=true; src.connect(this.dryEq); src.connect(this.eq); this.sourceNode=src; src.start(); this.isPlaying=true; }
      createPinkNoiseBuffer(seconds=4){ const sr=this.ctx.sampleRate, len=Math.floor(sr*seconds); const buf=this.ctx.createBuffer(2,len,sr); for(let ch=0; ch<2; ch++){ const data=buf.getChannelData(ch); let b0=0,b1=0,b2=0; for(let i=0;i<len;i++){ const w=Math.random()*2-1; b0=0.99765*b0 + w*0.0990460; b1=0.96300*b1 + w*0.2965164; b2=0.57000*b2 + w*1.0526913; data[i]=(b0+b1+b2+w*0.1848)*0.05; } } return buf; }
    }

    let engine = null;
    let isPlaying = false;
    let abProcessed = false;
    let targetFreq = null; let targetGain = 0;
    let userFreq = null; let userGainChoice = 'none';
    let score = {correct:0,total:0};

    const yearEl = document.getElementById('year'); yearEl.textContent = new Date().getFullYear();
    const playBtn = document.getElementById('playBtn');
    const abA = document.getElementById('abA');
    const abB = document.getElementById('abB');
    const vol = document.getElementById('vol'); const volPct = document.getElementById('volPct');
    const freqGrid = document.getElementById('freqGrid');
    const checkBtn = document.getElementById('checkBtn');
    const newRoundBtn = document.getElementById('newRound');
    const hint = document.getElementById('hint');
    const inlineResult = document.getElementById('inlineResult');

    const scCorrect = document.getElementById('scCorrect'); const scTotal = document.getElementById('scTotal'); const scAcc = document.getElementById('scAcc');
    const logWrap = document.getElementById('log');
    const exportBtn = document.getElementById('exportBtn');
    const unlock = document.getElementById('unlock');
    const unlockBtn = document.getElementById('unlockBtn');

    function ensureEngine(){
      if(!engine){
        engine = new AudioEngine();
        engine.setMasterGain(parseFloat(vol.value||'0.9'));
        if(targetFreq===null){ targetFreq = 1000; targetGain = 0; }
        engine.setTargetEQ({freq: targetFreq, gainDb: targetGain});
        engine.setUserEQ({freq: userFreq||1000, gainDb: 0});
        setAB(true);
      }
    }

    function buildFreqButtons(){
      freqGrid.innerHTML = '';
      niceFreqs.forEach(f=>{
        const b=document.createElement('button'); b.className='choice'; b.textContent = fmtBand(f)+ ' Hz';
        b.addEventListener('click',()=>{ userFreq=f; updateFreqActive(); applyUserEQ(); updateHint(); });
        b.dataset.freq = f; freqGrid.appendChild(b);
      });
    }
    function updateFreqActive(){ Array.from(freqGrid.children).forEach(b=>{ b.classList.toggle('active', Number(b.dataset.freq)===userFreq); }); }

    function updateGainButtons(){ document.querySelectorAll('[data-gain]')
      .forEach(btn=> btn.classList.toggle('active', btn.dataset.gain===userGainChoice)); }

    function updateHint(){ const gainLabel = userGainChoice; hint.textContent = `Target: ${targetFreq? '(hidden)':'—'} | Your A: ${userFreq||'—'} Hz, ${gainLabel}`; }

    function updateStats(){ scCorrect.textContent = score.correct; scTotal.textContent = score.total; scAcc.textContent = score.total? Math.round(100*score.correct/score.total)+'%':'0%'; }

    function appendLogRow(row){ const div=document.createElement('div'); div.className='logrow';
      const resClass = row.result==='✔' ? 'pass' : 'fail';
      div.innerHTML = `<span class="w16 muted">${row.time}</span>
        <span class="w40">${row.exercise}</span>
        <span class="w40">Target: ${row.target}</span>
        <span class="w40">Guess: ${row.guess}</span>
        <span class="${resClass}">${row.result}</span>
        <span style="margin-left:auto" class="muted">${row.detail}</span>`;
      logWrap.prepend(div);
      while(logWrap.children.length>50){ logWrap.removeChild(logWrap.lastChild); }
    }

    function evaluateGuess(targetFreq, targetGain, userFreq, chosenGain){
      const idxTrue = niceFreqs.indexOf(targetFreq);
      const idxGuess = niceFreqs.indexOf(userFreq);
      const freqSteps = Math.abs(idxTrue - idxGuess);
      const gainOnly = (targetGain === 0);
      const ok = gainOnly ? (chosenGain === 0) : ((freqSteps <= 1) && (chosenGain === targetGain));
      return { ok, freqSteps, gainOnly };
    }

    function setAB(onB){
      abProcessed = onB;
      if(engine){ engine.toggleAB(onB); }
      abA.classList.toggle('active', !onB);
      abB.classList.toggle('active', onB);
    }

    function applyUserEQ(){
      const freq = userFreq || 1000;
      let gainDb = 0; if(userGainChoice==='boost') gainDb = MOD_GAIN_DB; if(userGainChoice==='cut') gainDb = -MOD_GAIN_DB;
      if(engine){ engine.setUserEQ({freq, gainDb}); }
    }

    function startFreqRound(){
      userGainChoice='none'; updateGainButtons();
      const freq = niceFreqs[Math.floor(Math.random()*niceFreqs.length)];
      const gain = weightedPick([-MOD_GAIN_DB, 0, MOD_GAIN_DB], [0.4, 0.2, 0.4]);
      targetFreq=freq; targetGain=gain; inlineResult.textContent='';
      if(engine){
        engine.bypassAll();
        engine.setTargetEQ({freq, gainDb:gain});
        engine.setUserEQ({freq:userFreq||1000, gainDb:0});
        setAB(true);
      }
      updateHint();
    }

    // Init
    buildFreqButtons();
    updateGainButtons(); updateHint(); updateStats();
    startFreqRound();

    playBtn.addEventListener('click', async ()=>{
      ensureEngine();
      try{ await engine.resume(); }catch(e){}
      if(!isPlaying){ engine.start(); isPlaying=true; playBtn.textContent='Stop'; unlock.hidden=true; }
      else { engine.stop(); isPlaying=false; playBtn.textContent='Play'; }
    });
    abA.addEventListener('click', ()=> { ensureEngine(); setAB(false); });
    abB.addEventListener('click', ()=> { ensureEngine(); setAB(true); });

    vol.addEventListener('input', (e)=>{ const v = parseFloat(e.target.value); if(engine){ engine.setMasterGain(v); } volPct.textContent = Math.round(v*100)+'%'; });

    document.querySelectorAll('[data-gain]').forEach(btn=> btn.addEventListener('click', ()=>{ userGainChoice = btn.dataset.gain; updateGainButtons(); applyUserEQ(); updateHint(); }));

    checkBtn.addEventListener('click', ()=>{
      if(targetFreq==null || userFreq==null) return;
      let chosenGain = 0; if(userGainChoice==='boost') chosenGain = MOD_GAIN_DB; if(userGainChoice==='cut') chosenGain = -MOD_GAIN_DB;
      const { ok, freqSteps, gainOnly } = evaluateGuess(targetFreq, targetGain, userFreq, chosenGain);
      const label = (g)=> g>0? 'Boost' : g<0? 'Cut':'No Boost/Cut';
      score = { correct: score.correct + (ok?1:0), total: score.total + 1 }; updateStats();
      const detail = gainOnly ? 'gain-only round (freq ignored)' : `Δfreq steps ${freqSteps}`;
      const row = { time:new Date().toLocaleTimeString(), exercise:'Freq/Gain Match', target: `${targetFreq} Hz, ${label(targetGain)}`, guess: `${userFreq} Hz, ${label(chosenGain)}`, result: ok? '✔':'✖', detail };
      appendLogRow(row);
      inlineResult.textContent = ok ? (gainOnly ? '✔ Match! (freq ignored)' : `✔ Match! (${freqSteps} steps)`) : (gainOnly ? '✖ Not yet. (need No Boost/Cut)' : `✖ Not yet. (${freqSteps} steps)`);
      inlineResult.className = ok? 'pass' : 'fail';
    });

    newRoundBtn.addEventListener('click', ()=> startFreqRound());

    function buildCSV(root = logWrap){
      const header = ["time","exercise","target","guess","result","detail"].join(",");
      const rows = Array.from(root.children).reverse().map(div=>{
        const parts = Array.from(div.querySelectorAll('span')).map(s=> s.textContent);
        return [parts[0], parts[1], parts[2].replace('Target: ','').trim(), parts[3].replace('Guess: ','').trim(), parts[4], parts[5]].join(",");
      });
      return [header, ...rows].join(NL);
    }

    exportBtn.addEventListener('click', ()=>{
      const csv = buildCSV();
      const blob = new Blob([csv], { type: "text/csv" });
      const url = URL.createObjectURL(blob);
      const stamp = new Date().toISOString().slice(0,19).replace(/[ :T]/g,'-');
      const a = document.createElement("a"); a.href = url; a.download = `ear_training_${stamp}.csv`; a.click(); URL.revokeObjectURL(url);
    });

    function maybeShowUnlock(){
      try{
        if(!engine || (engine && engine.ctx && engine.ctx.state !== 'running')){
          unlock.hidden = false;
        } else {
          unlock.hidden = true;
        }
      }catch{ unlock.hidden = false; }
    }

    document.addEventListener('visibilitychange', ()=>{ if(document.visibilityState==='visible') maybeShowUnlock(); });
    window.addEventListener('focus', maybeShowUnlock);
    window.addEventListener('load', maybeShowUnlock);

    unlockBtn.addEventListener('click', async ()=>{
      ensureEngine();
      try{ await engine.resume(); }catch(e){}
      if(!isPlaying){ engine.start(); isPlaying=true; playBtn.textContent='Stop'; }
      unlock.hidden = true;
    });
  </script>
</body>
</html>
